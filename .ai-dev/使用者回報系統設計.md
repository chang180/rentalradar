# 使用者回報系統設計

## 🎯 系統目標

### 核心功能
- 👤 **使用者註冊驗證**：真實使用者註冊和身份驗證
- 📝 **回報表單**：簡潔易用的回報表單
- ⚖️ **權重計算**：驗證使用者回報權重更高
- 🏆 **信譽評分**：使用者信譽度評分系統
- 📊 **資料品質**：確保回報資料的準確性

## 🏗️ 系統架構

### 使用者註冊驗證流程
```php
class UserRegistrationSystem
{
    public function registerUser($userData)
    {
        // 1. 基本資料驗證
        $validatedData = $this->validateRegistrationData($userData);
        
        // 2. 建立使用者帳號
        $user = $this->createUser($validatedData);
        
        // 3. 發送驗證郵件
        $this->sendVerificationEmail($user);
        
        // 4. 等待使用者驗證
        return $user;
    }
    
    public function verifyUser($verificationToken)
    {
        // 驗證使用者
        $user = $this->findUserByToken($verificationToken);
        if ($user) {
            $user->is_verified = true;
            $user->save();
            return true;
        }
        return false;
    }
}
```

### 使用者權重計算系統
```php
class UserWeightCalculator
{
    public function calculateUserWeight($userId)
    {
        $user = User::find($userId);
        
        // 基礎權重
        $baseWeight = 1.0;
        
        // 使用者信譽度 (0-100)
        $reputationBonus = $user->reputation_score / 100;
        
        // 歷史回報準確度 (0-100)
        $accuracyBonus = $user->historical_accuracy / 100;
        
        // 活躍度獎勵 (最多0.5)
        $activityBonus = min($user->report_count / 10, 0.5);
        
        // 驗證狀態獎勵
        $verificationBonus = $user->is_verified ? 0.2 : 0;
        
        $totalWeight = $baseWeight + $reputationBonus + $accuracyBonus + $activityBonus + $verificationBonus;
        
        return min($totalWeight, 3.0); // 最大權重3倍
    }
    
    public function updateUserReputation($userId, $reportAccuracy)
    {
        $user = User::find($userId);
        
        // 更新歷史準確度
        $newAccuracy = ($user->historical_accuracy * $user->report_count + $reportAccuracy) / ($user->report_count + 1);
        $user->historical_accuracy = $newAccuracy;
        
        // 更新信譽評分
        $reputationChange = $this->calculateReputationChange($reportAccuracy);
        $user->reputation_score = max(0, min(100, $user->reputation_score + $reputationChange));
        
        // 更新回報次數
        $user->report_count++;
        $user->last_report_at = now();
        
        $user->save();
    }
}
```

### 回報資料處理系統
```php
class UserReportProcessor
{
    public function processReport($reportData, $userId)
    {
        // 1. 使用者身份驗證
        $user = $this->validateUser($userId);
        if (!$user || !$user->is_verified) {
            throw new UnauthorizedException('使用者未驗證');
        }
        
        // 2. 表單驗證
        $validatedData = $this->validateForm($reportData);
        
        // 3. 資料真實性檢測
        $authenticityScore = $this->checkAuthenticity($validatedData);
        
        // 4. 與現有資料比對
        $consistencyScore = $this->checkConsistency($validatedData);
        
        // 5. 計算使用者權重
        $userWeight = $this->calculateUserWeight($user);
        
        // 6. 計算最終信心度
        $confidenceScore = $this->calculateConfidence($authenticityScore, $consistencyScore, $userWeight);
        
        // 7. 儲存回報資料
        $report = $this->saveReport($validatedData, $userId, $confidenceScore, $userWeight);
        
        return $report;
    }
    
    private function calculateConfidence($authenticityScore, $consistencyScore, $userWeight)
    {
        // 基礎信心度
        $baseConfidence = ($authenticityScore + $consistencyScore) / 2;
        
        // 使用者權重加成
        $weightedConfidence = $baseConfidence * $userWeight;
        
        return min(100, $weightedConfidence);
    }
}
```

## 📊 資料庫設計

### 使用者表
```sql
CREATE TABLE users (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    email VARCHAR(255) UNIQUE NOT NULL,
    name VARCHAR(100) NOT NULL,
    password VARCHAR(255) NOT NULL,
    is_verified BOOLEAN DEFAULT FALSE,
    verification_token VARCHAR(255),
    
    -- 使用者信譽評分
    reputation_score INT DEFAULT 0,      -- 信譽評分 (0-100)
    historical_accuracy DECIMAL(5,2) DEFAULT 0, -- 歷史準確度 (0-100)
    report_count INT DEFAULT 0,          -- 回報次數
    last_report_at TIMESTAMP,           -- 最後回報時間
    
    -- 系統欄位
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    INDEX idx_reputation (reputation_score),
    INDEX idx_verified (is_verified),
    INDEX idx_email (email)
);
```

### 使用者回報表
```sql
CREATE TABLE user_reports (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,
    
    -- 基本資訊
    county VARCHAR(10) NOT NULL,
    district VARCHAR(20) NOT NULL,
    address TEXT NOT NULL,
    rent_price DECIMAL(12,2) NOT NULL,
    area DECIMAL(8,2) NOT NULL,
    room_type VARCHAR(20) NOT NULL,
    
    -- 權重計算
    user_weight DECIMAL(5,2) DEFAULT 1.0, -- 使用者權重
    confidence_score INT DEFAULT 0,      -- 信心度評分
    authenticity_score INT DEFAULT 0,    -- 真實性評分
    consistency_score INT DEFAULT 0,     -- 一致性評分
    is_verified BOOLEAN DEFAULT FALSE,   -- 是否驗證通過
    
    -- 系統欄位
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    FOREIGN KEY (user_id) REFERENCES users(id),
    INDEX idx_user_id (user_id),
    INDEX idx_location (county, district),
    INDEX idx_confidence (confidence_score),
    INDEX idx_created_at (created_at)
);
```

## 🎨 前端介面設計

### 使用者註冊頁面
```jsx
const UserRegistrationForm = () => {
    const [formData, setFormData] = useState({
        name: '',
        email: '',
        password: '',
        confirmPassword: ''
    });
    
    const handleSubmit = async (e) => {
        e.preventDefault();
        
        // 表單驗證
        if (formData.password !== formData.confirmPassword) {
            setError('密碼確認不符');
            return;
        }
        
        // 提交註冊
        const response = await fetch('/api/register', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
        });
        
        if (response.ok) {
            setMessage('註冊成功！請檢查郵件進行驗證');
        }
    };
    
    return (
        <form onSubmit={handleSubmit} className="registration-form">
            <h2>註冊帳號</h2>
            
            <div className="form-group">
                <label>姓名</label>
                <input 
                    type="text" 
                    value={formData.name}
                    onChange={(e) => setFormData({...formData, name: e.target.value})}
                    required
                />
            </div>
            
            <div className="form-group">
                <label>電子郵件</label>
                <input 
                    type="email" 
                    value={formData.email}
                    onChange={(e) => setFormData({...formData, email: e.target.value})}
                    required
                />
            </div>
            
            <div className="form-group">
                <label>密碼</label>
                <input 
                    type="password" 
                    value={formData.password}
                    onChange={(e) => setFormData({...formData, password: e.target.value})}
                    required
                />
            </div>
            
            <div className="form-group">
                <label>確認密碼</label>
                <input 
                    type="password" 
                    value={formData.confirmPassword}
                    onChange={(e) => setFormData({...formData, confirmPassword: e.target.value})}
                    required
                />
            </div>
            
            <button type="submit" className="btn-primary">
                註冊
            </button>
        </form>
    );
};
```

### 回報表單頁面
```jsx
const ReportForm = () => {
    const [formData, setFormData] = useState({
        county: '',
        district: '',
        address: '',
        rent_price: '',
        area: '',
        room_type: ''
    });
    
    const handleSubmit = async (e) => {
        e.preventDefault();
        
        // 提交回報
        const response = await fetch('/api/reports', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${userToken}`
            },
            body: JSON.stringify(formData)
        });
        
        if (response.ok) {
            setMessage('回報成功！感謝您的貢獻');
        }
    };
    
    return (
        <form onSubmit={handleSubmit} className="report-form">
            <h2>回報租金資訊</h2>
            
            <div className="form-group">
                <label>縣市</label>
                <select 
                    value={formData.county}
                    onChange={(e) => setFormData({...formData, county: e.target.value})}
                    required
                >
                    <option value="">請選擇縣市</option>
                    <option value="台北市">台北市</option>
                    <option value="新北市">新北市</option>
                    {/* 其他縣市 */}
                </select>
            </div>
            
            <div className="form-group">
                <label>行政區</label>
                <input 
                    type="text" 
                    value={formData.district}
                    onChange={(e) => setFormData({...formData, district: e.target.value})}
                    required
                />
            </div>
            
            <div className="form-group">
                <label>地址</label>
                <input 
                    type="text" 
                    value={formData.address}
                    onChange={(e) => setFormData({...formData, address: e.target.value})}
                    required
                />
            </div>
            
            <div className="form-group">
                <label>租金 (元/月)</label>
                <input 
                    type="number" 
                    value={formData.rent_price}
                    onChange={(e) => setFormData({...formData, rent_price: e.target.value})}
                    required
                />
            </div>
            
            <div className="form-group">
                <label>坪數</label>
                <input 
                    type="number" 
                    value={formData.area}
                    onChange={(e) => setFormData({...formData, area: e.target.value})}
                    required
                />
            </div>
            
            <div className="form-group">
                <label>房型</label>
                <select 
                    value={formData.room_type}
                    onChange={(e) => setFormData({...formData, room_type: e.target.value})}
                    required
                >
                    <option value="">請選擇房型</option>
                    <option value="套房">套房</option>
                    <option value="雅房">雅房</option>
                    <option value="整層">整層</option>
                    <option value="其他">其他</option>
                </select>
            </div>
            
            <button type="submit" className="btn-primary">
                提交回報
            </button>
        </form>
    );
};
```

## 🚀 實作時程

### Phase 5: 使用者回報系統 (1週)
- [ ] **Day 1-2**: 開發使用者註冊驗證系統
- [ ] **Day 3-4**: 實作權重計算機制
- [ ] **Day 5-6**: 建立使用者信譽評分
- [ ] **Day 7**: 整合測試和優化

### 技術驗證重點
- [ ] **使用者驗證**：註冊和驗證流程的穩定性
- [ ] **權重計算**：使用者權重計算的準確性
- [ ] **信譽評分**：信譽度評分系統的效果
- [ ] **資料品質**：回報資料的品質控制

---

**🎯 系統價值：**
- 確保回報資料的真實性和準確性
- 建立使用者信譽評分機制
- 提升資料品質和可信度
- 為政府平台活化應用增加使用者參與功能
